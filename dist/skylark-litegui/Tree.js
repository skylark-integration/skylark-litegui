/**
 * skylark-litegui - A version of litegui.js  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-litegui/
 * @license MIT
 */
define(["./litegui"],function(t){function e(t,e,i){if(i||t&&t.constructor===String){var r=t;t=e,(e=i||{}).id=r,console.warn("LiteGUI.Tree legacy parameter, use data as first parameter instead of id.")}e=e||{};var n=document.createElement("div");this.root=n,e.id&&(n.id=e.id),n.className="litetree",this.tree=t;var s=this;e=e||{allow_rename:!1,allow_drag:!0,allow_multiselection:!1},this.options=e,this.indent_offset=e.indent_offset||0,e.height&&(this.root.style.height="string"==typeof e.height?e.height:Math.round(e.height)+"px"),this.collapsed_depth=3,null!=e.collapsed_depth&&(this.collapsed_depth=e.collapsed_depth),n.addEventListener("click",function(t){t.srcElement==s.root&&s.onBackgroundClicked&&s.onBackgroundClicked(t,s)}),n.addEventListener("contextmenu",function(t){return 2==t.button&&(s.onContextMenu&&s.onContextMenu(t),t.preventDefault(),!1)});var o=this.createAndInsert(t,e,null);if(!o)throw"Error in LiteGUI.Tree, createAndInsert returned null";o.className+=" root_item",this.root_item=o}return e.INDENT=20,e.prototype.updateTree=function(t){this.root.innerHTML="";var e=this.createAndInsert(t,this.options,null);e?(e.className+=" root_item",this.root_item=e):this.root_item=null},e.prototype.insertItem=function(t,e,i,r){if(!e){var n=this.root.childNodes[0];n&&(e=n.dataset.item_id)}var s=this.createAndInsert(t,r,e,i);return e&&this._updateListBox(this._findElement(e)),s},e.prototype.createAndInsert=function(t,e,i,r){var n=-1;i?n=this._findElementIndex(i):void 0===i&&(n=0);var s=null,o=0;-1!=n&&(s=this.root.childNodes[n],o=parseInt(s.dataset.level)+1);var a=this.createTreeItem(t,e,o);if(a){if(a.parent_id=i,this.getItem(a.dataset.item_id)&&console.warn("There another item with the same ID in this tree"),-1==n?this.root.appendChild(a):this._insertInside(a,n,r),s&&!this._isNodeChildrenVisible(i)&&a.classList.add("hidden"),t.children)for(var l=0;l<t.children.length;++l)this.createAndInsert(t.children[l],e,t.id);return this._updateListBox(a,e,o),e&&e.selected&&this.markAsSelected(a,!0),a}},e.prototype._insertInside=function(t,i,r,n){var s=this.root.childNodes[i];if(!s)throw"No parent node found, index: "+i+", nodes: "+this.root.childNodes.length;var o=parseInt(s.dataset.level),a=void 0!==n?n:o+1,l=t.querySelector(".indentblock");l&&(l.style.paddingLeft=(a+this.indent_offset)*e.INDENT+"px"),t.dataset.level=a;for(var d=i+1;d<this.root.childNodes.length;++d){var c=this.root.childNodes[d];if(c.classList&&c.classList.contains("ltreeitem")){var h=parseInt(c.dataset.level);if(h==a&&r)r--;else if(h<a||0===r&&h===a)return void this.root.insertBefore(t,c)}}this.root.appendChild(t)},e.prototype._isNodeChildrenVisible=function(t){var e=this.getItem(t);if(!e)return!1;if(e.classList.contains("hidden"))return!1;var i=e.querySelector(".listbox");return!i||"closed"!=i.getValue()},e.prototype._findElement=function(t){if(!t||t.constructor!==String)throw"findElement param must be string with item id";for(var e=0;e<this.root.childNodes.length;++e){var i=this.root.childNodes[e];if(i.classList&&i.classList.contains("ltreeitem")&&i.classList.contains("ltreeitem-"+t))return i}return null},e.prototype._findElementIndex=function(t){for(var e=0;e<this.root.childNodes.length;++e){var i=this.root.childNodes[e];if(i.classList&&i.classList.contains("ltreeitem"))if("string"==typeof t){if(i.dataset.item_id===t)return e}else if(i===t)return e}return-1},e.prototype._findElementLastChildIndex=function(t){if(-1==t)return-1;for(var e=parseInt(this.root.childNodes[t].dataset.level),i=t+1;i<this.root.childNodes.length;++i){var r=this.root.childNodes[i];if(r.classList&&r.classList.contains("ltreeitem"))if(parseInt(r.dataset.level)==e)return i}return-1},e.prototype._findChildElements=function(t,e){var i=this._findElementIndex(t);if(-1!=i){for(var r=this.root.childNodes[i],n=parseInt(r.dataset.level),s=[],o=i+1;o<this.root.childNodes.length;++o){var a=this.root.childNodes[o];if(a.classList&&a.classList.contains("ltreeitem")){var l=parseInt(a.dataset.level);if(!(e&&l>n+1)){if(l<=n)return s;s.push(a)}}}return s}},e.prototype.createTreeItem=function(e,i,r){if(null!==e&&void 0!==e){i=i||this.options;var n=document.createElement("li");n.className="ltreeitem";var s=this;if(e.id){var o=e.id.replace(/\s/g,"_");n.className+=" ltreeitem-"+o,n.dataset.item_id=e.id}if(e.dataset)for(var a in e.dataset)n.dataset[a]=e.dataset[a];e.DOM=n,n.data=e,void 0!==r&&(n.dataset.level=r,n.classList.add("ltree-level-"+r));var l=document.createElement("div");l.className="ltreeitemtitle",e.className&&(l.className+=" "+e.className),l.innerHTML="<span class='precontent'></span><span class='indentblock'></span><span class='collapsebox'></span><span class='incontent'></span><span class='postcontent'></span>";var d=e.content||e.id||"";if(l.querySelector(".incontent").innerHTML=d,e.precontent&&(l.querySelector(".precontent").innerHTML=e.precontent),e.postcontent&&(l.querySelector(".postcontent").innerHTML=e.postcontent),e.dataset)for(var a in e.dataset)n.dataset[a]=e.dataset[a];n.appendChild(l),n.title_element=l,!1===e.visible&&(n.style.display="none");var c=n;c.addEventListener("click",function(i){i.preventDefault(),i.stopPropagation();if(this.title_element._editing)return;if(i.ctrlKey&&s.options.allow_multiselection){if(s.isNodeSelected(this))return this.classList.remove("selected"),t.trigger(s,"item_remove_from_selection",{item:this,data:this.data}),void t.trigger(s.root,"item_remove_from_selection",{item:this,data:this.data});s.markAsSelected(this,!0),t.trigger(s,"item_add_to_selection",{item:this,data:this.data}),t.trigger(s.root,"item_add_to_selection",{item:this,data:this.data});var r=!1;e.callback&&(r=e.callback.call(s,this)),!r&&s.onItemAddToSelection&&s.onItemAddToSelection(this.data,this)}if(i.shiftKey&&s.options.allow_multiselection){var n=s.getSelectedItem();if(!n)return;if(n===this)return;for(var o=Array.prototype.slice.call(n.parentNode.children),a=o.indexOf(n),l=o.indexOf(this),d=l>a?o.slice(a,l):o.slice(l,a),c=0;c<d.length;++c){var h=d[c];s.markAsSelected(h,!0),t.trigger(s,"item_add_to_selection",{item:h,data:h.data}),t.trigger(s.root,"item_add_to_selection",{item:h,data:h.data})}}else{s.markAsSelected(this),s._skip_scroll=!0,t.trigger(s,"item_selected",{item:this,data:this.data}),t.trigger(s.root,"item_selected",{item:this,data:this.data});var r=!1;e.callback&&(r=e.callback.call(s,this)),!r&&s.onItemSelected&&s.onItemSelected(this.data,this),s._skip_scroll=!1}}),c.addEventListener("dblclick",function(e){var i=this,r=i.title_element.querySelector(".incontent");if(t.trigger(s,"item_dblclicked",i),t.trigger(s.root,"item_dblclicked",i),!r._editing&&s.options.allow_rename){r._editing=!0,r._old_name=r.innerHTML;var n=r;r.innerHTML="<input type='text' value='"+r.innerHTML+"' />";var o=r.querySelector("input");o.addEventListener("blur",function(e){var r=e.target.value;setTimeout(function(){n.innerHTML=r},1),delete n._editing,t.trigger(s.root,"item_renamed",{old_name:n._old_name,new_name:r,item:i,data:i.data}),delete n._old_name}),o.addEventListener("keydown",function(t){13==t.keyCode&&this.blur()}),o.focus(),e.preventDefault()}e.preventDefault(),e.stopPropagation()}),c.addEventListener("contextmenu",function(t){if(t.preventDefault(),t.stopPropagation(),2==t.button)return!!s.onItemContextMenu&&s.onItemContextMenu(t,{item:this,data:this.data})});var h=l;this.options.allow_drag&&(h.draggable=!0,h.addEventListener("dragstart",function(t){if(t.dataTransfer.setData("item_id",this.parentNode.dataset.item_id),e.onDragData){var i=e.onDragData();if(i)for(var r in i)t.dataTransfer.setData(r,i[r])}}));var f=0;return h.addEventListener("dragenter",function(t){if(t.preventDefault(),e.skipdrag)return!1;0==f&&l.classList.add("dragover"),f++}),h.addEventListener("dragleave",function(t){t.preventDefault(),0==--f&&l.classList.remove("dragover")}),h.addEventListener("dragover",function(t){t.preventDefault()}),h.addEventListener("drop",function(i){if(l.classList.remove("dragover"),i.preventDefault(),e.skipdrag)return!1;var r=i.dataTransfer.getData("item_id");if(!r)return t.trigger(s.root,"drop_on_item",{item:this,event:i}),void(s.onDropItem&&s.onDropItem(i,this.parentNode.data));var n=this.parentNode.dataset.item_id;(!s.onMoveItem||s.onMoveItem&&0!=s.onMoveItem(s.getItem(r),s.getItem(n)))&&s.moveItem(r,n)&&t.trigger(s.root,"item_moved",{item:s.getItem(r),parent_item:s.getItem(n)}),s.onDropItem&&s.onDropItem(i,this.parentNode.data)}),n}console.error("Tree item cannot be null")},e.prototype.filterByName=function(t){for(var i=0;i<this.root.childNodes.length;++i){var r=this.root.childNodes[i];if(r.classList&&r.classList.contains("ltreeitem")){var n=r.querySelector(".incontent");if(n){var s=n.innerHTML.toLowerCase();if(t&&-1==s.indexOf(t.toLowerCase()))r.classList.add("filtered");else{r.data&&!1!==r.data.visible&&r.classList.remove("filtered");var o=r.querySelector(".indentblock");o&&(o.style.paddingLeft=t?0:paddingLeft=(parseInt(r.dataset.level)+this.indent_offset)*e.INDENT+"px")}}}}},e.prototype.filterByRule=function(e,i){if(!e)throw"filterByRule requires a callback";for(var r=0;r<this.root.childNodes.length;++r){var n=this.root.childNodes[r];if(n.classList&&n.classList.contains("ltreeitem")){var s=n.querySelector(".incontent");if(s)if(e(n.data,s,i)){n.data&&!1!==n.data.visible&&n.classList.remove("filtered");var o=n.querySelector(".indentblock");o&&(name?o.style.paddingLeft=0:o.style.paddingLeft=paddingLeft=(parseInt(n.dataset.level)+this.indent_offset)*t.Tree.INDENT+"px")}else n.classList.add("filtered")}}},e.prototype.getItem=function(t){if(!t)return null;if(t.classList)return t;for(var e=0;e<this.root.childNodes.length;++e){var i=this.root.childNodes[e];if(i.classList&&i.classList.contains("ltreeitem")&&i.dataset.item_id===t)return i}return null},e.prototype.expandItem=function(t,e){var i=this.getItem(t);if(i&&i.listbox&&(i.listbox.setValue(!0),e)){var r=this.getParent(i);r&&this.expandItem(r,e)}},e.prototype.collapseItem=function(t){var e=this.getItem(t);e&&e.listbox&&listbox.setValue(!1)},e.prototype.isInsideArea=function(t){var e=t.constructor===String?this.getItem(t):t;if(!e)return!1;var i=this.root.getClientRects();if(!i.length)return!1;var r=i[0].height,n=e.offsetTop;return this.root.scrollTop<n&&n<this.root.scrollTop+r},e.prototype.scrollToItem=function(t){var i=t.constructor===String?this.getItem(t):t;if(i){var r=this.root.parentNode;if(r){var n=r.getBoundingClientRect();if(n){var s=n.height,o=(parseInt(i.dataset.level)+this.indent_offset)*e.INDENT+50;r.scrollTop=i.offsetTop-.5*s|0,.75*n.width<o?r.scrollLeft=o:r.scrollLeft=0}}}},e.prototype.setSelectedItem=function(e,i,r){if(e){var n=this.getItem(e);if(!n)return null;if(!n.classList.contains("selected"))return this.markAsSelected(n),i&&!this._skip_scroll&&this.scrollToItem(n),this.expandItem(n,!0),r&&t.trigger(n,"click"),n}else this.unmarkAllAsSelected()},e.prototype.addItemToSelection=function(t){if(t){var e=this.getItem(t);return e?(this.markAsSelected(e,!0),e):null}},e.prototype.removeItemFromSelection=function(t){if(t){var e=this.getItem(t);if(!e)return null;e.classList.remove("selected")}},e.prototype.getSelectedItem=function(){return this.root.querySelector(".ltreeitem.selected")},e.prototype.getSelectedItems=function(){return this.root.querySelectorAll(".ltreeitem.selected")},e.prototype.isItemSelected=function(t){var e=this.getItem(t);return!!e&&this.isNodeSelected(e)},e.prototype.getChildren=function(t,e){return t&&t.constructor!==String&&t.dataset&&(t=t.dataset.item_id),this._findChildElements(t,e)},e.prototype.getParent=function(t){var e=this.getItem(t);return e?this.getItem(e.parent_id):null},e.prototype.getAncestors=function(t,e){e=e||[];var i=this.getItem(t);return i?(e.push(i),this.getAncestors(i.parent_id,e)):e},e.prototype.isAncestor=function(t,e){var i=this.getItem(t);if(!i)return!1;var r=this.getItem(e),n=this.getItem(i.parent_id);return!!n&&(n==r||this.isAncestor(n,e))},e.prototype.moveItem=function(t,e){if(t===e)return!1;var i=this.getItem(t),r=this.getItem(e);if(this.isAncestor(r,i))return!1;var n=this._findElementIndex(r),s=parseInt(r.dataset.level),o=this.getParent(i);if(!o)return console.error("node parent not found by id, maybe id has changed"),!1;var a=s-parseInt(o.dataset.level);if(!r||!i)return!1;if(r==o)return!1;i.parent_id=e;var l=this.getChildren(i);if(l){l.unshift(i);for(var d=0;d<l.length;d++)l[d].parentNode.removeChild(l[d]);for(d=0;d<l.length;d++){var c=l[d],h=parseInt(c.dataset.level)+a;c.dataset.level=h}n=this._findElementIndex(r);var f=this._findElementLastChildIndex(n);-1==f&&(f=0);for(d=0;d<l.length;d++){c=l[d];this._insertInside(c,n,f+d-1,parseInt(c.dataset.level))}}return this._updateListBox(r),o&&this._updateListBox(o),!0},e.prototype.removeItem=function(t,e){var i=t;if("string"==typeof t&&(i=this.getItem(t)),!i)return!1;var r=this.getParent(i),n=null;if(e&&(n=this.getChildren(i)),this.root.removeChild(i),n)for(var s=0;s<n.length;s++)this.root.removeChild(n[s]);return r&&this._updateListBox(r),!0},e.prototype.updateItem=function(t,e){var i=this.getItem(t);if(!i)return!1;(i.data=e,e.id&&(i.id=e.id),e.content)&&(i.title_element.querySelector(".incontent").innerHTML=e.content);return!0},e.prototype.updateItemId=function(t,e){var i=this.getItem(t);if(!i)return!1;var r=this.getChildren(t,!0);i.id=e;for(var n=0;n<r.length;++n){r[n].parent_id=e}return!0},e.prototype.clear=function(t){if(t)for(var e=this.root.querySelectorAll(".ltreeitem"),i=1;i<e.length;i++){var r=e[i];this.root.removeChild(r)}else this.root.innerHTML=""},e.prototype.getNodeByIndex=function(t){return this.root.querySelectorAll(".ltreeitem")[t]},e.prototype.unmarkAllAsSelected=function(){this.root.classList.remove("selected");var t=this.root.querySelectorAll(".ltreeitem.selected");if(t)for(var e=0;e<t.length;e++)t[e].classList.remove("selected");var i=this.root.querySelectorAll(".ltreeitem.semiselected");for(e=0;e<i.length;e++)i[e].classList.remove("semiselected")},e.prototype.isNodeSelected=function(t){return!!t.classList.contains("selected")},e.prototype.markAsSelected=function(t,e){if(!t.classList.contains("selected")){e||this.unmarkAllAsSelected(),t.classList.add("selected");for(var i=this.getParent(t),r=[];i&&-1==r.indexOf(i);)i.classList.add("semiselected"),r.push(i),i=this.getParent(i)}},e.prototype._updateListBox=function(e,i,r){if(e){var n=this;if(!e.listbox){var s=e.title_element.querySelector(".collapsebox"),o=t.createLitebox(!0,function(i){n.onClickBox(i,e),t.trigger(n.root,"item_collapse_change",{item:e,data:o.getValue()})});o.stopPropagation=!0,o.setEmpty(!0),s.appendChild(o),e.listbox=o}(i&&i.collapsed||r>=this.collapsed_depth)&&e.listbox.collapse();var a=this.getChildren(e.dataset.item_id);a&&(a.length?e.listbox.setEmpty(!1):e.listbox.setEmpty(!0))}},e.prototype.onClickBox=function(t,e){var i=this.getChildren(e);if(i)for(var r=0;r<i.length;++r){var n=i[r],s=this.getParent(n),o=!0;s&&(o=this._isNodeChildrenVisible(s)),o?n.classList.remove("hidden"):n.classList.add("hidden")}},t.Tree=e});
//# sourceMappingURL=sourcemaps/Tree.js.map
